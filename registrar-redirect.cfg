#
# $Id$
#
# this example shows use of ser as a registrar server
#

# ------------------ module loading ----------------------------------

debug=2            # debug level
fork=yes
log_stderror=yes
listen=127.0.0.1:5060
 
#set module path
mpath="/usr/lib/x86_64-linux-gnu/kamailio/modules/"

loadmodule "sl.so"
loadmodule "usrloc.so"
loadmodule "registrar.so"
loadmodule "pv.so"
loadmodule "xlog.so"
modparam("xlog", "buf_size", 8192)

# -------------------------  request routing logic -------------------
# main routing logic

request_route{
	xlog("L_INFO", "Received request ($rm) from ($fu)\n");

	if (method == "REGISTER") {
		xlog("L_INFO", "REGISTER with AoR ($tu) and Contact ($ct)\n");
		save("location");	
		exit;
	}

	if (method == "INVITE") {
		xlog("L_INFO", "INVITE from ($fu) to ($tu)\n");
	    if ($tu =~ ".+@a.pt") {   # belongs to local domain
			if (!lookup("location")) {
		    	 sl_send_reply("404", "Not Found"); # entry not found in registrar
        	} else {
				xlog("L_INFO", "Redirecting to ($ru)\n");
				sl_send_reply("300", "Redirect"); # redirecting to Contact
        	}
    	} else {
			sl_send_reply("403", "Cannot redirect"); # not redirecting (out of a.pt)
		}
	}
}